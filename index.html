<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Data Transformer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f4f7f6; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: sans-serif; }
        .card { width: 100%; max-width: 450px; border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 2rem; background: white; }
        .step-num { color: #0d6efd; font-weight: bold; margin-right: 5px; }
        .form-label { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: #6c757d; margin-bottom: 0.5rem; }
        .btn-primary { padding: 0.75rem; font-weight: 600; border-radius: 8px; margin-top: 1rem; }
    </style>
</head>
<body>

<div class="card">
    <h4 class="mb-4 text-center">Transform Activity Data</h4>
    
    <div class="mb-3">
        <label class="form-label"><span class="step-num">1.</span> Activity Master (CSV)</label>
        <input class="form-control" type="file" id="masterFile" accept=".csv">
    </div>

    <div class="mb-3">
        <label class="form-label"><span class="step-num">2.</span> CPR File (XLSX / CSV)</label>
        <input class="form-control" type="file" id="cprFile" accept=".xlsx, .xls, .csv">
    </div>

    <div class="mb-3">
        <label class="form-label"><span class="step-num">3.</span> Activity Attendance (CSV)</label>
        <input class="form-control" type="file" id="attendanceFile" accept=".csv">
    </div>

    <button class="btn btn-primary w-100" onclick="processData()">Generate CSV Output</button>
</div>

<script>
// Standard CSV Parser
function parseCSV(file) {
    return new Promise((resolve) => {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => resolve(results.data)
        });
    });
}

// Excel Parser for CPR File (skips metadata rows)
function parseCPRExcel(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            // {range: 9} skips the first 9 rows (0-8) to reach the headers on row 10
            const jsonData = XLSX.utils.sheet_to_json(sheet, { range: 9 });
            resolve(jsonData);
        };
        reader.readAsArrayBuffer(file);
    });
}

async function processData() {
    const masterFile = document.getElementById('masterFile').files[0];
    const cprFile = document.getElementById('cprFile').files[0];
    const attendanceFile = document.getElementById('attendanceFile').files[0];

    if (!masterFile || !cprFile || !attendanceFile) {
        alert("Please upload all three files.");
        return;
    }

    const masterData = await parseCSV(masterFile);
    const attendanceData = await parseCSV(attendanceFile);
    
    // Handle CPR as Excel or CSV
    let cprData;
    if (cprFile.name.endsWith('.csv')) {
        // If CSV, we use PapaParse with a manual skip (less common for CPR, but safe)
        const rawCpr = await parseCSV(cprFile);
        cprData = rawCpr; 
    } else {
        cprData = await parseCPRExcel(cprFile);
    }

    // 1. Map Master Data: Activity Name -> GUI
    const masterMap = new Map(masterData.map(row => [row.activitydisplay, row.gui]));

    // 2. Map CPR Data: UIN/NRIC -> CFS (1-9)
    // The CPR headers are specifically "UIN / NRIC" and "CFS (1-9)"
    const cprMap = new Map(cprData.map(row => [row["UIN / NRIC"], row["CFS (1-9)"]]));

    // 3. Process Attendance and Join
    const output = attendanceData.map(row => {
        const nric = row.registrationdocumentnumber;
        const activityName = row.activitydisplay;

        return {
            activitydatedisplay: row.activitydatedisplay,
            activitydisplay: activityName,
            fullname: row.fullname || '',
            age: row.age || '',
            postalcode1: row.postalcode1 || '',
            gender: row.gender || '',
            registrationdocumentnumber: nric,
            gui: masterMap.get(activityName) || '', 
            cfs: cprMap.get(nric) || ''              
        };
    });

    downloadCSV(output);
}

function downloadCSV(data) {
    const csv = Papa.unparse(data);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `transformed_activities_${new Date().toISOString().slice(0,10)}.csv`);
    link.click();
}
</script>

</body>
</html>
