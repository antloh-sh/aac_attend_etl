<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance ETL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    body { background: #f4f7f6; color: #333; font-family: -apple-system, sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
    .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 400px; }
    h2 { margin-top: 0; font-size: 1.5rem; text-align: center; color: #111; margin-bottom: 30px; }
    .group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-size: 0.75rem; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
    input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    .btn { width: 100%; padding: 14px; background: #007bff; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px; font-size: 1rem; }
    .btn:hover { background: #0056b3; }
    .status { margin-top: 20px; text-align: center; font-size: 0.85rem; color: #888; }
  </style>
</head>
<body>

<div class="card">
  <h2>Data Transformer</h2>
  
  <div class="group">
    <label>1. Activity Master (XLSX)</label>
    <input type="file" id="masterFile" accept=".xlsx">
  </div>

  <div class="group">
    <label>2. CPR File (XLSX)</label>
    <input type="file" id="cprFile" accept=".xlsx">
  </div>

  <div class="group">
    <label>3. Activity Attendance (CSV)</label>
    <input type="file" id="attendanceFile" accept=".csv">
  </div>

  <button class="btn" onclick="process()">Generate CSV</button>
  <div id="status" class="status"></div>
</div>

<script>
  // Preserving your exact Date Formatting logic
  function formatActivityDate(str) {
    if (!str) return "";
    const match = str.match(/^(\d{1,2})-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d{4})/i);
    if (!match) return str;
    const d = match[1].padStart(2, "0");
    const mStr = match[2].toLowerCase();
    const y = match[3].slice(-2);
    const months = { jan:"01", feb:"02", mar:"03", apr:"04", may:"05", jun:"06", jul:"07", aug:"08", sep:"09", oct:"10", nov:"11", dec:"12" };
    return `${d}-${months[mStr]}-${y}`;
  }

  function parseExcel(file, skipRows = 0) {
    return new Promise(res => {
      const reader = new FileReader();
      reader.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
        res(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { range: skipRows }));
      };
      reader.readAsArrayBuffer(file);
    });
  }

  function parseCSV(file) {
    return new Promise(res => {
      Papa.parse(file, { header: true, skipEmptyLines: true, complete: out => res(out.data) });
    });
  }

  async function process() {
    const mFile = document.getElementById('masterFile').files[0];
    const cFile = document.getElementById('cprFile').files[0];
    const aFile = document.getElementById('attendanceFile').files[0];

    if (!mFile || !cFile || !aFile) return alert("Please select all three files.");
    
    document.getElementById('status').innerText = "Processing...";

    // 1. Load Data
    const masterData = await parseExcel(mFile, 0);
    const cprData = await parseExcel(cFile, 9); // Skip 9 metadata rows
    const attendanceData = await parseCSV(aFile);

    // 2. Build Lookup Maps
    const masterMap = new Map();
    masterData.forEach(r => {
      const actName = r.Activity || r.ActivityDisplay;
      if (actName) {
        const guiVal = String(r.GUI || '').trim().toLowerCase();
        masterMap.set(actName.trim(), guiVal.startsWith('yes') ? "TRUE" : "FALSE");
      }
    });

    const cprMap = new Map();
    cprData.forEach(r => {
      const nric = r["UIN / NRIC"];
      if (nric) cprMap.set(String(nric).trim(), r["CFS (1-9)"] || "");
    });

    // 3. ETL Logic (Filter, Truncate Name, Format Date, Join)
    const processed = attendanceData
      .filter(row => String(row.Attendance) === "1")
      .map(row => {
        const rawActivity = row.ActivityDisplay || "";
        const cleanActivity = rawActivity.split('\n')[0].trim();
        const nric = (row.RegistrationDocumentNumber || "").trim();

        return {
          activitydatedisplay: formatActivityDate(row.ActivityDateDisplay),
          activitydisplay: cleanActivity,
          fullname: row.FullName || "",
          age: row.Age || "",
          postalcode1: row.PostalCode1 || "",
          gender: row.Gender || "",
          registrationdocumentnumber: nric,
          gui: masterMap.get(cleanActivity) || "FALSE",
          cfs: cprMap.get(nric) || ""
        };
      });

    // 4. Download
    const csv = Papa.unparse(processed);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `AAC_Transformed_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
    
    document.getElementById('status').innerText = `Done! ${processed.length} rows processed.`;
  }
</script>

</body>
</html>
