<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance ETL - Supabase Native</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    body { background: #f8fafc; color: #334155; font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
    .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); width: 100%; max-width: 400px; border: 1px solid #e2e8f0; }
    h2 { margin-top: 0; font-size: 1.2rem; text-align: center; margin-bottom: 2rem; color: #0f172a; }
    .group { margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.5rem; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
    input { width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px; }
    .btn { width: 100%; padding: 0.8rem; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .btn:hover { background: #2563eb; }
    .status { margin-top: 1.5rem; text-align: center; font-size: 0.8rem; color: #94a3b8; }
  </style>
</head>
<body>

<div class="card">
  <h2>Supabase Data Transformer</h2>
  
  <div class="group">
    <label>1. Activity Master (XLSX)</label>
    <input type="file" id="masterFile" accept=".xlsx">
  </div>

  <div class="group">
    <label>2. CPR File (XLSX)</label>
    <input type="file" id="cprFile" accept=".xlsx">
  </div>

  <div class="group">
    <label>3. Attendance (CSV)</label>
    <input type="file" id="attendanceFile" accept=".csv">
  </div>

  <button class="btn" onclick="process()">Generate CSV for Supabase</button>
  <div id="status" class="status">Ready</div>
</div>

<script>
  // UPDATED: Formats "19-Nov-2025" to "2025-11-19" for Supabase DATE type
  function formatToISODate(str) {
    if (!str) return "";
    const match = str.match(/^(\d{1,2})-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d{4})/i);
    if (!match) return str;
    
    const day = match[1].padStart(2, "0");
    const monthStr = match[2].toLowerCase();
    const year = match[3];
    const months = { jan:"01", feb:"02", mar:"03", apr:"04", may:"05", jun:"06", jul:"07", aug:"08", sep:"09", oct:"10", nov:"11", dec:"12" };
    
    return `${year}-${months[monthStr]}-${day}`;
  }

  async function parseExcel(file, skipRows = 0) {
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data);
    return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { range: skipRows });
  }

  function parseCSV(file) {
    return new Promise(res => {
      Papa.parse(file, { header: true, skipEmptyLines: true, complete: out => res(out.data) });
    });
  }

  async function process() {
    const mFile = document.getElementById('masterFile').files[0];
    const cFile = document.getElementById('cprFile').files[0];
    const aFile = document.getElementById('attendanceFile').files[0];

    if (!mFile || !cFile || !aFile) return alert("Select all files");
    document.getElementById('status').innerText = "Processing...";

    const masterData = await parseExcel(mFile, 0);
    const cprData = await parseExcel(cFile, 9);
    const attendanceData = await parseCSV(aFile);

    const masterMap = new Map();
    masterData.forEach(r => {
      const act = r.Activity || r.ActivityDisplay;
      if (act) {
        // UPDATED: Stores as boolean true/false instead of string "TRUE"
        const isGui = String(r.GUI || '').toLowerCase().startsWith('yes');
        masterMap.set(act.trim(), isGui); 
      }
    });

    const cprMap = new Map();
    cprData.forEach(r => {
      if (r["UIN / NRIC"]) cprMap.set(String(r["UIN / NRIC"]).trim(), r["CFS (1-9)"] || "");
    });

    const results = attendanceData
      .filter(row => String(row.Attendance) === "1")
      .map(row => {
        const cleanAct = (row.ActivityDisplay || "").split('\n')[0].trim();
        const nric = (row.RegistrationDocumentNumber || "").trim();

        return {
          activitydatedisplay: formatToISODate(row.ActivityDateDisplay), // YYYY-MM-DD
          activitydisplay: cleanAct,
          fullname: row.FullName || "",
          age: row.Age || "",
          postalcode1: row.PostalCode1 || "",
          gender: row.Gender || "",
          registrationdocumentnumber: nric,
          gui: masterMap.has(cleanAct) ? masterMap.get(cleanAct) : false, // boolean true/false
          cfs: cprMap.get(nric) || ""
        };
      });

    const csv = Papa.unparse(results);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `supabase_ready_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
    document.getElementById('status').innerText = "Download Complete";
  }
</script>
</body>
</html>
